<script setup>
import { ref, computed } from 'vue'
import './App.css'
import BookCard from './BookCard.vue'

import duneCover from './assets/covers/dune_cover.png'
import kosinogCover from './assets/covers/kosinog_cover.png'
import solarisCover from './assets/covers/solaris_cover.png'
import earthCover from './assets/covers/earth_cover.png'
import leftHandCover from './assets/covers/left_hand_cover.png'
import picnicCover from './assets/covers/piknik_cover.png'
import noImageCover from './assets/covers/no_image_cover.png'

const books = ref([
  {
    id: 1,
    title: '–î—é–Ω–∞',
    description: '–≠–ø–∏—á–µ—Å–∫–∞—è –Ω–∞—É—á–Ω–æ-—Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∞—è —Å–∞–≥–∞ –§—Ä—ç–Ω–∫–∞ –ì–µ—Ä–±–µ—Ä—Ç–∞ –æ –≤–ª–∞—Å—Ç–∏, —Ä–µ–ª–∏–≥–∏–∏ –∏ —ç–∫–æ–ª–æ–≥–∏–∏ –ø–ª–∞–Ω–µ—Ç—ã –ê—Ä—Ä–∞–∫–∏—Å.',
    genre: '–ù–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞',
    cover: duneCover,
    adult: false,
    rating: 4
  },
  {
    id: 2,
    title: '–ö–æ—Å–∏–Ω–æ–≥. –ò—Å—Ç–æ—Ä–∏—è –æ –∫–æ–ª–¥–æ–≤—Å—Ç–≤–µ',
    description: '–§—ç–Ω—Ç–µ–∑–∏–π–Ω—ã–π —Ä–æ–º–∞–Ω –æ –º–∞–≥–∏–∏, –¥—Ä–µ–≤–Ω–∏—Ö —Å–∏–ª–∞—Ö –∏ —Å—É–¥—å–±–µ —á–µ–ª–æ–≤–µ–∫–∞ –º–µ–∂–¥—É –¥–≤—É–º—è –º–∏—Ä–∞–º–∏.',
    genre: '–§—ç–Ω—Ç–µ–∑–∏',
    cover: kosinogCover,
    adult: true,
    rating: 3
  },
  {
    id: 3,
    title: '–°–æ–ª—è—Ä–∏—Å',
    description: '–§–∏–ª–æ—Å–æ—Ñ—Å–∫–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞ –°—Ç–∞–Ω–∏—Å–ª–∞–≤–∞ –õ–µ–º–∞ –æ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–Ω—è—Ç—å —á—É–∂–¥—ã–π —Ä–∞–∑—É–º.',
    genre: '–§–∏–ª–æ—Å–æ—Ñ—Å–∫–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞',
    cover: solarisCover,
    adult: false,
    rating: 4
  },
  {
    id: 4,
    title: '–í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—Ä–æ—à–ª–æ–º –ó–µ–º–ª–∏',
    description: '–¶–∏–∫–ª –õ—é –¶—ã—Å–∏–Ω—è –æ –ø–µ—Ä–≤–æ–º –∫–æ–Ω—Ç–∞–∫—Ç–µ —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–∞ —Å –∏–Ω–æ–ø–ª–∞–Ω–µ—Ç–Ω–æ–π —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–µ–π.',
    genre: '–¢–≤—ë—Ä–¥–∞—è –Ω–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞',
    cover: earthCover,
    adult: false,
    rating: 5
  },
  {
    id: 5,
    title: '–õ–µ–≤–∞—è —Ä—É–∫–∞ –¢—å–º—ã',
    description: '–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞ –£—Ä—Å—É–ª—ã –õ–µ –ì—É–∏–Ω –æ –ø–ª–∞–Ω–µ—Ç–µ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º –æ–±—â–µ—Å—Ç–≤–∞.',
    genre: '–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞',
    cover: leftHandCover,
    adult: true,
    rating: 3
  },
  {
    id: 6,
    title: '–ü–∏–∫–Ω–∏–∫ –Ω–∞ –æ–±–æ—á–∏–Ω–µ',
    description: '–†–æ–º–∞–Ω –±—Ä–∞—Ç—å–µ–≤ –°—Ç—Ä—É–≥–∞—Ü–∫–∏—Ö –æ –∑–∞–≥–∞–¥–æ—á–Ω–æ–π –ó–æ–Ω–µ –∏ –µ—ë –æ–ø–∞—Å–Ω—ã—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö.',
    genre: '–ù–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞',
    cover: picnicCover,
    adult: true,
    rating: 2
  }
])

const showAdult = ref(false)
const sortHighToLow = ref(true)
const isFormOpen = ref(false)
const editingBookId = ref(null)

// –§–∏–ª—å—Ç—Ä 18+
const filteredBooks = computed(() => {
  return books.value.filter(book => showAdult.value || !book.adult)
})

// –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É
const sortedBooks = computed(() => {
  return [...filteredBooks.value].sort((a, b) =>
      sortHighToLow.value ? b.rating - a.rating : a.rating - b.rating
  )
})

// –®–∞–±–ª–æ–Ω —Ñ–æ—Ä–º—ã
const form = ref({
    title: '',
    description: '',
    cover: '',
    genre: '',
    adult: false,
    rating: 0
})

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
const totalBooks = computed(() => books.value.length)
const averageRating = computed(() => {
  const rated = books.value.filter(b => b.rating > 0) // –û—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–∏–≥–∏ —Ç–æ–ª—å–∫–æ —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º > 0
  if(!rated.length) return '0.00'
  const avgRating = rated.reduce((sum,book) => sum + book.rating, 0) / rated.length // sum = 0
  return avgRating.toFixed(2)
})

// –û—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
const openCreateForm = () => {
  resetForm()
  isFormOpen.value = true
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–Ω–∏–≥—É
const saveBook = () => {
  if (editingBookId.value){
    const book = books.value.find(b => b.id === editingBookId.value)
    Object.assign(book, form.value) // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –≤ –∫–Ω–∏–≥—É
  } else {
    books.value.push({
      id: Date.now(),
      ...form.value
    })
  }
  resetForm()
}
// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É
const openEditForm = (book) => {
  form.value = { ...book }
  editingBookId.value = book.id
  isFormOpen.value = true
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∫–∏–Ω–∏–≥
const deleteBook = (id) => {
  books.value = books.value.filter(b => b.id !== id) // –£–¥–∞–ª—è–µ–º –ø–æ id
}

// –°–±—Ä–æ—Å —Ä–µ–π—Ç–∏–Ω–≥–∞
const resetRatings = () => {
  books.value.forEach(b => b.rating = 0) // –ó–∞–¥–∞–µ–º —É –≤—Å–µ—Ö –∫–Ω–∏–≥ –∑–Ω–∞—á–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞ = 0
}

// –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
const resetForm = () => {
  form.value = {
    title: '',
    description: '',
    cover: '',
    genre: '',
    adult: false,
    rating: 0
  }
  editingBookId.value = null
  isFormOpen.value = false
}

</script>

<template>
  <div class="container">
    <h1>üìö –†–µ–π—Ç–∏–Ω–≥ –∫–Ω–∏–≥</h1>


    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ -->
    <div class="controls">
      <label>
        <input type="checkbox" v-model="showAdult" /> –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å 18+
      </label>

      <button @click="sortHighToLow = !sortHighToLow">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É {{ sortHighToLow ? '‚ñº' : '‚ñ≤' }}</button>
      <button @click="openCreateForm">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
      <button @click="resetRatings">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥–∏</button>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats">
      <p>–í—Å–µ–≥–æ –∫–Ω–∏–≥: {{ totalBooks }}</p>
      <p>–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: {{ averageRating }}</p>
    </div>

    <!-- –§–æ—Ä–º–∞ -->
    <div v-if="isFormOpen" class="form">
      <input v-model="form.title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
      <textarea v-model="form.description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
      <input v-model="form.cover" placeholder="URL –æ–±–ª–æ–∂–∫–∏" />
      <select v-model="form.genre">
        <option disabled value="">–í—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä</option>
        <option>–ù–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞</option>
        <option>–§—ç–Ω—Ç–µ–∑–∏</option>
        <option>–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞</option>
        <option>–§–∏–ª–æ—Å–æ—Ñ—Å–∫–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞</option>
        <option>–¢–≤—ë—Ä–¥–∞—è –Ω–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞</option>
        <option>–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞</option>
        <option>–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è</option>
        <option>–î–µ—Ç–µ–∫—Ç–∏–≤</option>
        <option>–£–∂–∞—Å—ã</option>
        <option>–†–æ–º–∞–Ω—Ç–∏–∫–∞</option>
        <option>–ö–∏–±–µ—Ä–ø–∞–Ω–∫</option>
        <option>–≠–ø–∏—á–µ—Å–∫–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞</option>
      </select>
      <label><input type="checkbox" v-model="form.adult" /> 18+</label>
      <div class="form-actions">
        <button @click="saveBook">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button @click="resetForm">–û—Ç–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ -->
    <div class="grid">
      <BookCard v-for="book in sortedBooks" :key="book.id" :book="book" @edit="openEditForm" @delete="deleteBook"/>
    </div>
  </div>
</template>
